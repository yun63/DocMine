### Mysql优化

#### 1 如何优化？

1. 设计数据库时，数据库表，字段，存储引擎
2. 创建索引
3. 横向扩展：Mysql集群、负载均衡、读写分离
4. 分库分表
5. SQL语句的优化（优化有限）



#### 2 字段设计

原则：

1. 尽量使用整型表示字符串

2. 定长和非定长数据类型的选择

3. 字符串存储

   定长char，非定长varchar、text（上限65535）varchar会消耗1~3字节记录长度，text使用额外空间记录长度

4. 尽可能选择小的数据类型和指定短的长度

5. 尽可能使用not null

   非null字段的处理要比null字段的处理高效，且不需要判断是否为null。null存储需要额外的空间，运算也需要特殊的运算符，只能通过is null或者is not null来判断字符是否为null

6. 表字段不宜过多，可以预留字段

#### 3 存储引擎

1. MYISAM：不支持事务，以读写插入为主的应用程序，比如博客、新闻门户网站
2. InnoDB：支持事务，保证数据完整性，并发高

#### 4 索引

索引：关键字与数据的映射关系成为索引。关键字是从数据当中提取的用于标识、检索数据的特定内容。



索引的存储结构：BTree（多路平衡查找树），一种广泛应用于磁盘上实现索引功能的数据结构



##### 4.1 索引为什么快？

1. 关键字相当于数据本身，数据量小
2. 关键字是有序的，可以通过高效的查找算法确定数据的位置

#### 4. 2 Mysql索引类型

1. 普通索引（key）

   对关键词没有限制

2. 唯一索引（unique key）

   关键字不能重复

3. 主键索引（primary key）

   关键字唯一且不为null

4. 全文索引（fulltext key）

##### 4.3 Mysql索引的使用场景

1. 子查询where

2. order by

   当使用order by将查询结构按照某个字段排序时，如果该字段未建立索引，那么Mysql将会对查询出的所有数据进行外部排序（将数据从磁盘分批读取到内存使用内部排序，最后在内存中进行合并），影响性能。

3. join

   对join语句匹配关系（on）涉及的字段建立索引能够提高效率

4. 字段要单独出现

   ```mysql
   select * from user where id = 20-1;
   select * from user where id+1 = 20;
   ```

   第一条会使用主键索引，第二条不会。

5. like查询，不能以通配符开头，否则用不了索引，只能全表扫描，效率极低

6. 复合索引只对第一个字段有效

7. 状态值，枚举值不容易使用索引

##### 4.4 索引覆盖

如果要要查询的字段都建立了索引，那么Mysql会直接在索引表中查询而不会访问原始数据；否则只要有一个字段没有建立索引就会做全表扫描，这叫索引覆盖。因此，我们需要尽可能的在select后只写必要的查询字段，以增加索引覆盖的几率。

##### 4.5 创建索引

1. 在where、orderby、join字段上建立索引
2. 增加个别字段可能出现索引覆盖，可以考虑为该字段建立索引
3. 不常用到的索引，应该删除掉

#### 5 分区

当数据表中的数据量很大时，分区带来的效率提升才会显现出来。

只有检索字段为分区字段时，分区带来的效率提升才会明显。

##### 5.1 水平分割与垂直分割

水平分割：通过建立结构相同的表分别储存数据

垂直分割：将经常一起使用的字段放在一个单独的表中，分割后的表记录之间是一一对应关系

##### 5.2 为什么分表？

* 减轻数据库压力
* 分区算法局限

