## OOM异常排查过程

Java堆内存的OutOfMemoryError是在实际应用中最常见的内存溢出异常情况。

出现Java堆内存溢出时，异常堆栈信息"java.lang.OutOfMemoryErro"会跟随进一步提示 "Java heap space"。



> 将堆的最小是-Xms参数与最大值-Xmx参数设置为一样可以避免堆内存自动扩展而引发内存抖动问题，设置因此程序崩溃
>
> 通过参数-XX:+HeapDumpOnOutOfMemoryError可以让虚拟机再出现OOM时自动Dump出当前内存堆转储快照以便进行时候分析。



排查过程：

1. 设置启动JVM启动参数 `-XX:+HeapDumpOnOutOfMemoryError`
2. 通过内存映像分析工具（Eclipse Memory Analyzer，即MAT）对Dump出来的堆转储快照进行分析。第一步确认内存中导致OOM的对象是否是必要的，也就是分析出到底是出现了内存泄漏（Memory Leak）还是内存溢出（OOM）
3. 如果是内存泄漏，可进一步通过工具查看泄漏对象到GC Roots的引用链，找到泄漏对象是通过怎样的引用路径、与哪些GC Roots相关联，才导致垃圾收集器无法回收它们。根据泄漏对象的类型信息以及它到引用链的信息，一般可以比较准确的定位到这些对象创建的位置，进而找不产生内存泄漏的代码的具体位置。
4. 如果不是内存泄漏，那就是内存中的对象确实都是必须存活的，需要检查Java虚拟机的对参数（-Xmx和-Xms）的设置，与机器的内存对比，看看是否还有向上调整的空间。再从代码上检查是否存在某些对象生命周期过长、持有状态时间过长、存储结构设计不合理等情况，尽量减少程序运行期间的内存消耗。